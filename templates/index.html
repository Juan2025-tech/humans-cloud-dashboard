<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>HumanS ‚Äì Monitor Vital (AI Report + Diagn√≥stico)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: "Segoe UI", sans-serif; background:#eef2f7; margin:0; padding:0; -webkit-font-smoothing:antialiased; }
    .container { max-width:900px; margin:24px auto; padding:20px; background:#eaf6ff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
    h1 { text-align:center; color:#123e66; margin:0 0 8px; }
    h2 { text-align:center; color:#123e66; margin:24px 0 12px; font-size:1.4em; }

    .status { display:inline-block; text-align:center; margin:10px auto; padding:6px 14px; border-radius:8px; font-weight:700; }
    .connected { background:white; color:#155724; border: 2px solid #155724; }
    .disconnected { background:white; color:#c92a2a; border:2px solid #c92a2a; }

    .top-row { display:flex; gap:20px; align-items:center; justify-content:center; margin-top:12px; }
    .big { text-align:center; min-width:160px; }
    .label { font-weight:600; color:#34495e; margin-bottom:6px; }
    .value { font-family:"Courier New", monospace; font-size:84px; font-weight:800; }
    .value.good { color:#27ae60; }
    .value.warn { color:#e74c3c; }

    .patient-box { margin:14px auto; background: rgba(255,255,255,0.8); padding:12px; border-radius:8px; text-align:left; width:92%; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    .patient-box input { padding: 5px 8px; margin: 0 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .patient-box label { font-weight: 600; color: #34495e; margin-right: 6px; }
    
    canvas { width:100% !important; height:320px !important; display:block; }

    .controls { text-align:center; margin-top:12px; }
    .btn { padding:8px 14px; border-radius:8px; border:none; cursor:pointer; background:#1c70d6; color:white; font-weight:700; margin:6px 6px; }
    .btn.secondary { background:#6c757d; }
    .btn.predict { background:#28a745; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .alerting { box-shadow:0 0 0 8px rgba(231,76,60,0.10); border-radius:12px; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(231,76,60,0.0);} 50% { box-shadow:0 0 0 12px rgba(231,76,60,0.12);} 100% { box-shadow:0 0 0 0 rgba(231,76,60,0.0);} }

    #loadingBox { margin-top:18px; padding:14px; background:white; border-radius:10px; display:none; text-align:center; box-shadow:0 6px 22px rgba(0,0,0,0.06); }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1c70d6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* DIAGN√ìSTICO DE OPERACIONES */
    .diagnostics-section { margin-top:24px; padding:16px; background:rgba(255,255,255,0.9); border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .diagnostics-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px; }
    .diag-card { padding:10px; background:#f8f9fa; border-radius:6px; border-left:4px solid #1c70d6; }
    .diag-card .diag-label { font-size:0.85em; color:#6c757d; font-weight:600; margin-bottom:4px; }
    .diag-card .diag-value { font-size:1.8em; font-weight:700; color:#123e66; font-family:"Courier New", monospace; }

    @media (max-width:768px) {
      .value { font-size:56px; }
      .patient-box input { font-size: 12px; padding: 3px 6px; }
      .diagnostics-grid { grid-template-columns: 1fr; }
    }
    @media (max-width:520px) {
      .diagnostics-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container" id="mainCard">
    <h1>HumanS ‚Äì Monitor Vital (AI Report)</h1>
    <div id="status" class="status disconnected">Conectando...</div>

    <!-- DATOS DEL PACIENTE -->
    <div class="patient-box">
      <div>
        <label>Paciente:</label>
        <input type="text" id="patientName" value="Paciente01" placeholder="Nombre del paciente">
        &nbsp;&nbsp;
        <label>Edad:</label>
        <input type="number" id="patientAge" value="81" placeholder="Edad" style="width: 60px;">
        a√±os
      </div>
      <div style="margin-top: 8px;">
        <label>Residencia:</label>
        <input type="text" id="patientResidence" value="Residencia Albareda" placeholder="Residencia">
        &nbsp;&nbsp;
        <label>Habitaci√≥n:</label>
        <input type="text" id="patientRoom" value="101" placeholder="Habitaci√≥n" style="width: 80px;">
      </div>
    </div>

    <div class="top-row">
      <div class="big">
        <div class="label">SpO‚ÇÇ (%)</div>
        <div id="spo2" class="value">--</div>
      </div>

      <div class="big">
        <div class="label">HR (bpm)</div>
        <div id="hr" class="value">--</div>
      </div>
    </div>

    <canvas id="dualChart"></canvas>

    <div class="controls">
      <button id="pauseBtn" class="btn secondary">Pausar</button>
      <button id="clearBtn" class="btn">Borrar historial</button>
      <button id="reportBtn" class="btn predict">Informe m√©dico (PDF)</button>
    </div>

    <div id="loadingBox">
      <div class="spinner"></div>
      <p>Generando informe m√©dico con IA...</p>
    </div>

    <!-- SECCI√ìN DE DIAGN√ìSTICO DE OPERACIONES -->
    <div class="diagnostics-section">
      <h2>üîß Diagn√≥stico de Operaciones BLE</h2>
      
      <div class="diagnostics-grid">
        <div class="diag-card">
          <div class="diag-label">Paquetes Recibidos</div>
          <div class="diag-value" id="packetCount">0</div>
        </div>
        
        <div class="diag-card" style="border-left-color: #28a745;">
          <div class="diag-label">Distancia (metros)</div>
          <div class="diag-value" id="distance">--</div>
        </div>
        
        <div class="diag-card" style="border-left-color: #ffc107;">
          <div class="diag-label">RSSI (dBm)</div>
          <div class="diag-value" id="rssi">--</div>
        </div>
      </div>
      
      <div style="margin-top:12px; padding:10px; background:#e7f3ff; border-radius:6px; font-size:0.85em; color:#123e66;">
        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> La distancia se calcula bas√°ndose en la intensidad de se√±al RSSI. 
        Valores t√≠picos: &lt;1m (excelente) | 1-3m (bueno) | &gt;3m (d√©bil).
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('error', (ev) => console.error('Error:', ev.message));

    let socket = null;
    try {
      socket = typeof io !== 'undefined' ? io('http://127.0.0.1:5000') : {
        on: (e, cb) => console.log('[fallback] on', e),
        emit: (e, p) => console.log('[fallback] emit', e, p)
      };
    } catch (e) {
      console.warn('socket.io fallback:', e);
      socket = { on: () => {}, emit: () => {} };
    }

    let dualChart = null;
    try {
      const ctx = document.getElementById('dualChart').getContext('2d');
      dualChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'SpO‚ÇÇ', data: [], borderColor: '#0074D9', tension: 0.2, yAxisID: 'y' },
            { label: 'HR', data: [], borderColor: '#FF4136', tension: 0.2, yAxisID: 'y1' }
          ]
        },
        options: {
          animation: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { type: 'linear', position: 'left', min: 60, max: 100, title: { display: true, text: 'SpO‚ÇÇ %' } },
            y1: { type: 'linear', position: 'right', min: 30, max: 180, grid: { drawOnChartArea: false }, title: { display: true, text: 'HR bpm' } }
          }
        }
      });
    } catch (e) {
      console.warn('Chart.js fallback:', e);
    }

    let paused = false;
    document.getElementById('pauseBtn').onclick = () => {
      paused = !paused;
      document.getElementById('pauseBtn').textContent = paused ? 'Reanudar' : 'Pausar';
    };

    document.getElementById('clearBtn').onclick = () => {
      if (dualChart) {
        dualChart.data.labels = [];
        dualChart.data.datasets[0].data = [];
        dualChart.data.datasets[1].data = [];
        dualChart.update();
      }
      document.getElementById('spo2').textContent = '--';
      document.getElementById('hr').textContent = '--';
    };

    let audioCtx = null;
    function playAlertBeep(repeat = 1) {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        for (let i = 0; i < repeat; i++) {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.value = 900;
          g.gain.value = 0.12;
          o.connect(g);
          g.connect(audioCtx.destination);
          const start = window.performance.now() + i * 250;
          o.start(start / 1000);
          setTimeout(() => { try { o.stop(); } catch (e) {} }, 520 + i * 250);
        }
      } catch (e) {
        console.log('Audio error:', e);
      }
    }

    const mainCard = document.getElementById('mainCard');
    function setAlertOn(on) {
      on ? mainCard.classList.add('alerting') : mainCard.classList.remove('alerting');
    }

    // ACTUALIZACI√ìN NORMAL DE MONITORIZACI√ìN
    socket.on('update', data => {
      if (paused) return;
      try {
        const spo2El = document.getElementById('spo2');
        const hrEl = document.getElementById('hr');
        spo2El.textContent = data.spo2 ?? '--';
        hrEl.textContent = data.hr ?? '--';
        spo2El.className = 'value ' + (data.spo2_critical ? 'warn' : 'good');
        hrEl.className = 'value ' + (data.hr_critical ? 'warn' : 'good');

        if (dualChart && data.spo2_history && data.hr_history) {
          const labels = data.spo2_history.map((_, i) => i);
          dualChart.data.labels = labels;
          dualChart.data.datasets[0].data = data.spo2_history;
          dualChart.data.datasets[1].data = data.hr_history;
          dualChart.update();
        }

        if (data.spo2_critical || data.hr_critical) {
          setAlertOn(true);
          playAlertBeep();
        } else {
          setAlertOn(false);
        }
      } catch (e) {
        console.warn('Error update:', e);
      }
    });

    // ACTUALIZACI√ìN DE DIAGN√ìSTICO DE OPERACIONES
    socket.on('raw_update', data => {
      try {
        // Actualizar contador de paquetes
        document.getElementById('packetCount').textContent = data.count || 0;
        
        // Actualizar distancia
        const distanceEl = document.getElementById('distance');
        if (data.distance !== undefined && data.distance !== null) {
          distanceEl.textContent = data.distance + 'm';
          
          // Cambiar color seg√∫n calidad de se√±al
          const card = distanceEl.closest('.diag-card');
          if (data.distance < 1) {
            card.style.borderLeftColor = '#28a745'; // Verde: Excelente
          } else if (data.distance < 3) {
            card.style.borderLeftColor = '#ffc107'; // Amarillo: Bueno
          } else {
            card.style.borderLeftColor = '#dc3545'; // Rojo: D√©bil
          }
        } else {
          distanceEl.textContent = '--';
        }
        
        // Actualizar RSSI
        const rssiEl = document.getElementById('rssi');
        if (data.rssi !== undefined && data.rssi !== null) {
          rssiEl.textContent = data.rssi;
        } else {
          rssiEl.textContent = '--';
        }

      } catch (e) {
        console.warn('Error raw_update:', e);
      }
    });

    socket.on('connect', () => {
      const st = document.getElementById('status');
      st.textContent = "Conectado";
      st.className = "status connected";
    });

    socket.on('disconnect', () => {
      const st = document.getElementById('status');
      st.textContent = "Desconectado";
      st.className = "status disconnected";
    });

    // GENERACI√ìN DE INFORME
    const reportBtn = document.getElementById('reportBtn');
    const loadingBox = document.getElementById('loadingBox');

    reportBtn.addEventListener('click', async () => {
      reportBtn.disabled = true;
      loadingBox.style.display = 'block';

      try {
        const patientData = {
          name: document.getElementById('patientName').value || 'No especificado',
          age: document.getElementById('patientAge').value || 'No especificado',
          residence: document.getElementById('patientResidence').value || 'No especificado',
          room: document.getElementById('patientRoom').value || 'No especificado'
        };

        console.log('[INFO] Enviando solicitud con datos:', patientData);

        const response = await fetch('/api/report/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(patientData)
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `informe_medico_${new Date().toISOString().slice(0, 10)}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
          alert('Informe m√©dico descargado exitosamente.');
        } else {
          const errorText = await response.text();
          console.error('[ERROR] Respuesta del servidor:', errorText);
          alert(`Error al generar el informe.\n${errorText}`);
        }
      } catch (error) {
        console.error('[ERROR] Excepci√≥n:', error);
        alert(`Error de conexi√≥n: ${error.message}`);
      } finally {
        reportBtn.disabled = false;
        loadingBox.style.display = 'none';
      }
    });
  </script>
</body>
</html>